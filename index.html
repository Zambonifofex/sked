<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>body part scaling tool for Senran Kagura</title>
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<script type="module">
			let hex = string => parseInt(string, 0x10)
			
			let input = document.querySelector("#file")
			let offsets = document.querySelector("#offsets")
			
			let data = document.querySelectorAll(`[data-offset]`)
			
			let buffer
			let view
			
			let floatView = new DataView(new ArrayBuffer(4))
			let setFloat = (offset, float) =>
			{
				floatView.setFloat32(0, float)
				view.setUint8(offset + 0, floatView.getUint8(3))
				view.setUint8(offset + 1, floatView.getUint8(2))
				view.setUint8(offset + 2, floatView.getUint8(1))
				view.setUint8(offset + 3, floatView.getUint8(0))
			}
			let getFloat = offset =>
			{
				floatView.setUint8(0, view.getUint8(offset + 3))
				floatView.setUint8(1, view.getUint8(offset + 2))
				floatView.setUint8(2, view.getUint8(offset + 1))
				floatView.setUint8(3, view.getUint8(offset + 0))
				return floatView.getFloat32(0)
			}
			
			let filename
			input.addEventListener("change", async () =>
			{
				let file = input.files[0]
				if (!file) return
				
				filename = file.name
				buffer = await file.arrayBuffer()
				view = new DataView(buffer)
			})
			
			for (let input of data)
			{
				input.type = "number"
				input.step = "any"
				input.min = "0"
				input.addEventListener("change", () =>
				{
					for (let offset of offsets.querySelectorAll("option:checked"))
						setFloat(hex(input.dataset.offset) + hex(offset.value), input.valueAsNumber)
				})
			}
			
			// Derived from this: https://stackoverflow.com/a/35708911
			// Note that the problem is a little different, since we’re trying to find the double precision number whose shortest decimal representation round‐trips back to the given “single precision number” (represented as a double precision).
			// Whereas the problem in the question is to find the shortest string that round‐trips.
			// (Hopefully this makes sense and works, and there are no edge‐cases.)
			let powers = [6, 7, 8, 9]
			let round = float =>
			{
				for (let power of powers)
				{
					let scale = 10 ** power
					
					let rounded = Math.round(float * scale) / scale
					floatView.setFloat32(0, rounded)
					if (floatView.getFloat32(0) === float)
						return rounded
				}
				// Should never get here. (Hopefully.)
			}
			
			let compound = document.querySelectorAll("legend > input")
			
			offsets.addEventListener("input", () =>
			{
				for (let input of compound) input.value = ""
				
				let [first, ...rest] = offsets.querySelectorAll("option:checked")
				
				if (!first)
				{
					for (let input of data) input.value = ""
					return
				}
				
				for (let input of data)
				{
					let ioffset = hex(input.dataset.offset)
					let startOffset = ioffset + hex(first.value)
					let value = view.getUint32(startOffset)
					input.valueAsNumber = round(getFloat(startOffset))
					for (let offset of rest)
					{
						if (view.getUint32(ioffset + hex(offset.value)) !== value)
						{
							input.value = ""
							break
						}
					}
				}
			})
			
			document.querySelector("#download").addEventListener("click", () =>
			{
				let a = document.createElement("a")
				document.body.append(a)
				let url = URL.createObjectURL(new Blob([buffer]))
				a.href = url
				a.download = filename
				a.click()
				URL.revokeObjectURL(url)
				a.remove()
			})
			
			for (let input of compound)
			{
				input.type = "number"
				input.step = "any"
				input.min = "0"
				let inputs = input.closest("fieldset").querySelectorAll(":not(legend) > input")
				input.addEventListener("input", () =>
				{
					let value = input.valueAsNumber
					if (value !== value) return
					for (let other of inputs) other.valueAsNumber = value
				})
				
				input.addEventListener("change", () =>
				{
					for (let other of inputs)
					for (let offset of offsets.querySelectorAll("option:checked"))
						setFloat(hex(other.dataset.offset) + hex(offset.value), other.valueAsNumber)
				})
				
				for (let other of inputs) other.addEventListener("input", () => input.value = "")
			}
		</script>
		<link rel="stylesheet" href="style.css">
	</head>
	<body>
		<h1>body part scaling tool for Senran Kagura</h1>
		<p>
			This webapplication facilitates modifying body part scaling for Senran Kagura games such as Shinovi Versus and Estival Versus.
		</p>
		<p>
			To be able to use it, <strong>the first step is to select the body scaling file from your computer</strong> (oftentimes named <samp>plbodyscl.bin</samp>). After the file has been loaded, a character can be selected for modification in the list below. Note that multiple characters can be selected for batch modification by dragging on the list or using <kbd>ctrl‐click</kbd>.
		</p>
		<p>
			Once editing is done, the modified file can be saved to the filesystem by activating the “download” button.
		</p>
		<h2>features and benefits</h2>
		<ul>
			<li>Plain standard HTML and JavaScript — Works on any modern browser.</li>
			<li>Ease of use — The webapplication (I hope) is easy to use, and doesn’t require any in‐depth knowledge about computing.</li>
			<li>Easy to hack — Made to be really simple to modify and adapt by developers. (If this doesn’t include a character you want, it’s simple to add them.)</li>
			<li>Batch editing — Modify values of multiple characters at the same time by selecting multiple characters to modify.</li>
			<li>Nondestructive — Only modifies the relevant part of  the file, leaves the rest intact. Performs modifications in memory, leaves the original file intact.</li>
		</ul>
		<h2>hacking</h2>
		<p>
			This project is <a href="https://github.com/Zambonifofex/sked">available on GitHub</a>, and is distributed under the 0BSD license.
		</p>
		<p>Contributions and issues are welcome!</p>
		<main>
			<h2>modifying body part scaling</h2>
			<p>
				<input type="file" id="file">
				<label class="button" id="file-label" for="file">Select your <samp>plbodyscl.bin</samp> file</label>
				<strong>This is important!</strong> (Read above.)
			</p>
			<div>
				<p>
					<select multiple id="offsets">
						<optgroup label="Hanzo">
							<option value="0044">Asuka</option>
							<option value="01C4">Ikagura</option>
							<option value="0344">Katsuragi</option>
							<option value="04C4">Yagyu</option>
							<option value="0644">Hibari</option>
						</optgroup>
						<optgroup label="Crimson Squad">
							<option value="07C4">Homura</option>
							<option value="0944">Yomi</option>
							<option value="0AC4">Hikage</option>
							<option value="0C44">Mirai</option>
							<option value="0DC4">Haruka</option>
						</optgroup>
						<optgroup label="Gessen">
							<option value="0F44">Yumi</option>
							<option value="10C4">Murakumo</option>
							<option value="1244">Yozakura</option>
							<option value="13C4">Shiki</option>
							<option value="1544">Minori</option>
						</optgroup>
						<optgroup label="Hebijo">
							<option value="16C4">Miyabi</option>
							<option value="1844">Murasaki</option>
							<option value="19C4">Imu</option>
							<option value="1B44">Ryoubi</option>
							<option value="1CC4">Ryouna</option>
						</optgroup>
					</select>
				</p>
				<div>
					<fieldset>
						<legend>breasts <input></legend>
						<p>
							left:
							<input data-offset="0E4">
							<input data-offset="0E8">
							<input data-offset="0EC">
						</p>
						<p>
							right:
							<input data-offset="0CC">
							<input data-offset="0D0">
							<input data-offset="0D4">
						</p>
					</fieldset>
					<fieldset>
						<legend>hips <input></legend>
						<p>
							AS00:
							<input data-offset="024">
							<input data-offset="028">
							<input data-offset="02C">
						</p>
						<p>
							AS01:
							<input data-offset="03C">
							<input data-offset="040">
							<input data-offset="044">
						</p>
					</fieldset>
					<div>
						<p>
							head:
							<input data-offset="0B4">
							<input data-offset="0B8">
							<input data-offset="0BC">
						</p>
						<p>
							thorax:
							<input data-offset="084">
							<input data-offset="088">
							<input data-offset="08C">
						</p>
						<p>
							neck:
							<input data-offset="09C">
							<input data-offset="0A0">
							<input data-offset="0A4">
						</p>
					</div>
					<fieldset>
						<legend>back <input></legend>
						<p>
							lback:
							<input data-offset="054">
							<input data-offset="058">
							<input data-offset="05C">
						</p>
						<p>
							uback:
							<input data-offset="06C">
							<input data-offset="070">
							<input data-offset="074">
						</p>
					</fieldset>
					<fieldset>
						<legend>elbows <input></legend>
						<p>
							left:
							<input data-offset="114">
							<input data-offset="118">
							<input data-offset="11C">
						</p>
						<p>
							right:
							<input data-offset="0FC">
							<input data-offset="100">
							<input data-offset="104">
						</p>
					</fieldset>
					<fieldset>
						<legend>groin <input></legend>
						<p>
							left:
							<input data-offset="144">
							<input data-offset="148">
							<input data-offset="14C">
						</p>
						<p>
							right:
							<input data-offset="12C">
							<input data-offset="130">
							<input data-offset="134">
						</p>
					</fieldset>
					<fieldset>
						<legend>knees <input></legend>
						<p>
							left:
							<input data-offset="174">
							<input data-offset="178">
							<input data-offset="17C">
						</p>
						<p>
							right:
							<input data-offset="15C">
							<input data-offset="160">
							<input data-offset="164">
						</p>
					</fieldset>
					<p><button id="download">download</button></p>
				</div>
			</div>
		</main>
		<footer>
			<p><small>made by Zambonifofex〜</small></p>
		</footer>
	</body>
</html>
